<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventilo Mika Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --accent: #4895ef;
            --bg: #f0f4f8;
            --card-white: #ffffff;
            --text-dark: #2b2d42;
            --text-muted: #8d99ae;
        }
        
        body { 
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            color: var(--text-dark);
            font-family: 'Inter', -apple-system, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 35px;
            padding: 30px;
            width: 100%;
            max-width: 420px;
            margin: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .status-pill {
            font-size: 0.8rem;
            padding: 6px 16px;
            border-radius: 50px;
            background: white;
            color: var(--primary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            font-weight: 600;
        }

        .control-section {
            background: white;
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.02);
        }

        .section-label {
            font-size: 0.75rem;
            font-weight: 800;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 15px;
            display: block;
        }

        .form-select {
            border: none;
            background-color: white;
            font-weight: 700;
            padding: 12px;
            border-radius: 15px;
            color: var(--primary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        /* BOUTONS */
        .btn-custom {
            border-radius: 18px;
            padding: 14px;
            font-weight: 700;
            border: none;
            transition: all 0.2s ease;
        }
        
        .btn-on { background: var(--primary); color: white; }
        .btn-off { background: #edf2f4; color: #8d99ae; }
        .btn-light-on { background: #ffbe0b; color: white; }
        
        .speed-btn {
            background: #f8f9fa;
            border: 1px solid #edf2f4;
            color: var(--text-dark);
            border-radius: 14px;
            font-weight: 700;
            height: 50px;
        }
        .speed-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 8px 15px rgba(67, 97, 238, 0.3);
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container py-4">
    <div id="configScreen" class="main-card hidden text-center">
        <h4 class="mb-4 fw-bold">Configuration</h4>
        <input type="text" id="accessId" class="form-control mb-3 p-3 rounded-4 shadow-sm border-0" placeholder="Access ID">
        <input type="password" id="accessSecret" class="form-control mb-4 p-3 rounded-4 shadow-sm border-0" placeholder="Access Secret">
        <button onclick="saveConfig()" class="btn btn-primary w-100 p-3 rounded-4 fw-bold">Valider</button>
    </div>

    <div id="controlScreen" class="main-card hidden">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <span id="status" class="status-pill"><i class="fas fa-circle-notch fa-spin me-2"></i>Initialisation...</span>
            <button onclick="clearConfig()" class="btn btn-link text-muted"><i class="fas fa-sign-out-alt"></i></button>
        </div>

        <select id="deviceSelect" class="form-select mb-4" onchange="updateUI()"></select>

        <div class="control-section">
            <span class="section-label">Moteur</span>
            <div class="row g-2 mb-3">
                <div class="col-6"><button onclick="send('fan_switch', true)" class="btn btn-custom btn-on w-100 shadow-sm">ALLUMER</button></div>
                <div class="col-6"><button onclick="send('fan_switch', false)" class="btn btn-custom btn-off w-100">ÉTEINDRE</button></div>
            </div>
            
            <span class="section-label">Vitesse</span>
            <div class="row row-cols-3 g-2">
                <div class="col"><button onclick="sendSpeed(1)" class="btn speed-btn w-100">1</button></div>
                <div class="col"><button onclick="sendSpeed(2)" class="btn speed-btn w-100">2</button></div>
                <div class="col"><button onclick="sendSpeed(3)" class="btn speed-btn w-100">3</button></div>
                <div class="col"><button onclick="sendSpeed(4)" class="btn speed-btn w-100">4</button></div>
                <div class="col"><button onclick="sendSpeed(5)" class="btn speed-btn w-100">5</button></div>
                <div class="col"><button onclick="sendSpeed(6)" class="btn speed-btn w-100">MAX</button></div>
            </div>
        </div>

        <div id="lightSection" class="control-section hidden">
            <span class="section-label">Lumière Intégrée</span>
            <div class="row g-2">
                <div class="col-6"><button onclick="send('switch_led', true)" class="btn btn-custom btn-light-on w-100 shadow-sm"><i class="fas fa-lightbulb me-2"></i>ON</button></div>
                <div class="col-6"><button onclick="send('switch_led', false)" class="btn btn-custom btn-off w-100">OFF</button></div>
            </div>
        </div>

        <div class="control-section mb-0">
            <span class="section-label">Saison</span>
            <div class="row g-2">
                <div class="col-6"><button onclick="send('fan_direction', 'forward')" class="btn speed-btn w-100">ÉTÉ</button></div>
                <div class="col-6"><button onclick="send('fan_direction', 'reverse')" class="btn speed-btn w-100">HIVER</button></div>
            </div>
        </div>
    </div>
</div>

<script>
    function saveConfig() {
        localStorage.setItem('tuya_id', document.getElementById('accessId').value);
        localStorage.setItem('tuya_secret', document.getElementById('accessSecret').value);
        location.reload();
    }
    function clearConfig() { if(confirm("Supprimer les clés ?")) { localStorage.clear(); location.reload(); } }

    async function apiCall(data) {
        const res = await fetch('/api/control', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                accessId: localStorage.getItem('tuya_id'),
                accessSecret: localStorage.getItem('tuya_secret'),
                ...data
            })
        });
        return await res.json();
    }

    async function updateUI() {
        const deviceId = document.getElementById('deviceSelect').value;
        if(!deviceId) return;
        const data = await apiCall({ action: 'getSchema', deviceId });
        const lightSection = document.getElementById('lightSection');
        if (data.success) {
            const hasLight = (data.result.functions || []).some(f => f.code === 'switch_led');
            hasLight ? lightSection.classList.remove('hidden') : lightSection.classList.add('hidden');
            document.getElementById('status').innerHTML = '<i class="fas fa-check me-2"></i>Connecté';
        }
    }

    async function init() {
        if (!localStorage.getItem('tuya_id')) return document.getElementById('configScreen').classList.remove('hidden');
        document.getElementById('controlScreen').classList.remove('hidden');
        const data = await apiCall({ action: 'listDevices' });
        if (data.success) {
            const select = document.getElementById('deviceSelect');
            select.innerHTML = data.result.map(d => `<option value="${d.id}">${d.name.toUpperCase()}</option>`).join('');
            updateUI();
        }
    }

    async function send(code, value) {
        const deviceId = document.getElementById('deviceSelect').value;
        document.getElementById('status').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>...';
        const data = await apiCall({ action: 'send', deviceId, code, value });
        if (data.success) {
            document.getElementById('status').innerHTML = '<i class="fas fa-check me-2"></i>Reçu';
            setTimeout(() => { document.getElementById('status').innerHTML = '<i class="fas fa-check me-2"></i>Connecté'; }, 1500);
        }
    }

    async function sendSpeed(level) {
        // Gère l'effet visuel sur les boutons de vitesse
        document.querySelectorAll('.speed-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        send('fan_speed', level);
    }

    init();
</script>
</body>
</html>
